<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>GRAVITY RUNNER</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a2e;overflow:hidden;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;display:flex;justify-content:center;align-items:center;height:100vh;width:100vw}
canvas{display:block;cursor:pointer;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
'use strict';
const cv=document.getElementById('c'),cx=cv.getContext('2d');
let W=400,H=700,GY=600,RX=70;
const RW=30,RH=44;
const GRAV=0.065,BG=0.7,JV=-2.6,BS=1.5,MS=3.2,SI=0.0004,TVEL=0.65,DRAG=0.958;
const FN='"Press Start 2P",monospace';
let cRect,portrait=true;

function detectLayout(){
 const p=innerHeight>innerWidth;
 if(p){W=400;H=700;GY=600;RX=70;}
 else{W=800;H=450;GY=370;RX=140;}
 portrait=p;
}
function resize(){
 detectLayout();
 const r=W/H;let w=innerWidth,h=innerHeight;
 if(w/h>r)w=h*r;else h=w/r;
 cv.style.width=(w|0)+'px';cv.style.height=(h|0)+'px';
 cv.width=W;cv.height=H;cRect=cv.getBoundingClientRect();
 cx.imageSmoothingEnabled=false;
 initStars();
}
addEventListener('resize',resize);
addEventListener('orientationchange',()=>setTimeout(resize,150));

function gc(ex,ey){const r=cRect;return{x:(ex-r.left)*(W/r.width),y:(ey-r.top)*(H/r.height)};}
function inR(p,x,y,w,h){return p.x>=x&&p.x<=x+w&&p.y>=y&&p.y<=y+h;}
function rr(x,y,w,h,r){cx.beginPath();cx.moveTo(x+r,y);cx.lineTo(x+w-r,y);cx.quadraticCurveTo(x+w,y,x+w,y+r);cx.lineTo(x+w,y+h-r);cx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);cx.lineTo(x+r,y+h);cx.quadraticCurveTo(x,y+h,x,y+h-r);cx.lineTo(x,y+r);cx.quadraticCurveTo(x,y,x+r,y);cx.closePath();}
function txt(s,x,y,sz,c,a){cx.fillStyle=c||'#FFF';cx.font=sz+'px '+FN;cx.textAlign=a||'left';cx.textBaseline='middle';cx.fillText(s,x,y);}
function txts(s,x,y,sz,c,a){cx.fillStyle='#000';cx.font=sz+'px '+FN;cx.textAlign=a||'left';cx.textBaseline='middle';cx.fillText(s,x+1,y+1);cx.fillStyle=c||'#FFF';cx.fillText(s,x,y);}

// ===== STATE =====
let st='title';
let gs=BS,dist=0,gOff=0;
let rv={y:GY-RH,vy:0,og:true,al:true,jc:0,wA:0,sw:0};
let obs=[],pts=[],stars=[];
let ocd=120,shk=0;
let tPh='n',tA=0,tNx=null;
let ini=['A','A','A'],iSl=0,sLB=false;
let jP=false,fc=0;
let best=0,lb=[];
let tut=true,tutT=240;

// ===== STORAGE =====
function ld(){try{const d=JSON.parse(localStorage.getItem('gmoon3'));if(d){best=d.b||0;lb=d.l||[];}}catch(e){}}
function sv(){try{localStorage.setItem('gmoon3',JSON.stringify({b:best,l:lb}));}catch(e){}}
function svSc(){lb.push({n:ini.join(''),d:dist|0});lb.sort((a,b)=>b.d-a.d);lb=lb.slice(0,5);sv();}
function svBest(){if(dist>best){best=dist|0;sv();}}
ld();

// ===== STARS =====
const SC=['#FFF','#FFF','#FFE866','#66EEFF','#FF88CC','#88FF88'];
function initStars(){stars=[];for(let i=0;i<120;i++)stars.push({x:Math.random()*W,y:Math.random()*(GY-20),s:.5+Math.random()*1.5,b:Math.random(),sp:.003+Math.random()*.012,c:SC[(Math.random()*SC.length)|0]});}
initStars();
function drawStars(br){for(const s of stars){s.b+=s.sp;if(s.b>1)s.b=0;const a=(Math.abs(Math.sin(s.b*Math.PI))*.6+.4)*(br||1);cx.globalAlpha=a;cx.fillStyle=s.c;cx.fillRect(s.x|0,s.y|0,s.s<1?1:2,s.s<1?1:2);}cx.globalAlpha=1;}

// ===== PARTICLES =====
const PC=['#FFF','#FFE866','#FF8844','#66EEFF','#FFAA44'];
function addP(x,y,vx,vy,l,sz,col){if(pts.length>200)return;pts.push({x,y,vx:vx||(Math.random()-.5),vy:vy||-Math.random()*2,l:l||25,ml:l||25,sz:sz||2,c:col||PC[(Math.random()*PC.length)|0]});}
function updP(){for(let i=pts.length-1;i>=0;i--){const p=pts[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.03;p.l--;if(p.l<=0)pts.splice(i,1);}}
function drwP(){for(const p of pts){cx.globalAlpha=p.l/p.ml;cx.fillStyle=p.c;cx.fillRect(p.x|0,p.y|0,p.sz|0||1,p.sz|0||1);}cx.globalAlpha=1;}

// ===== ASTRONAUT (colorful pixel art) =====
function drwAstro(){
 const x=RX,y=rv.y,mx=x+RW/2;
 cx.save();
 if(!rv.og){
  cx.translate(mx,y+RH/2);
  const sway=Math.sin(rv.sw)*0.08+Math.max(-.08,Math.min(.08,rv.vy*.015));
  cx.rotate(sway);cx.translate(-mx,-y-RH/2);
 }
 // Jet flames
 if(!rv.og){
  const isD=rv.jc===2,fl=['#FF4400','#FF8800','#FFCC00','#FFEE88'];
  for(let i=0;i<(isD?5:2);i++){
   const fx=mx-3+(Math.random()*6)|0,fh=(3+Math.random()*(isD?14:6))|0;
   cx.fillStyle=fl[(Math.random()*fl.length)|0];cx.fillRect(fx,y+RH-1,2,fh);
  }
  if(isD&&rv.vy<-2){cx.fillStyle='rgba(255,200,0,0.15)';cx.beginPath();cx.arc(mx,y+RH+4,Math.abs(rv.vy)*2,0,Math.PI*2);cx.fill();}
 }
 // Ground shadow
 if(rv.og){cx.fillStyle='rgba(0,0,0,0.2)';cx.beginPath();cx.ellipse(mx,GY-1,10,3,0,0,Math.PI*2);cx.fill();}
 const wk=rv.og,ws=wk?Math.sin(rv.wA):0;
 const flt=!rv.og?(Math.sin(fc*0.015)*1.5)|0:0;
 // Legs
 if(wk){
  const ls=(ws*3)|0;
  cx.fillStyle='#D0D0D8';cx.fillRect(mx-6+ls,y+31,4,7);cx.fillRect(mx+2-ls,y+31,4,7);
  cx.fillStyle='#5566AA';cx.fillRect(mx-7+ls,y+37,6,5);cx.fillRect(mx+1-ls,y+37,6,5);
 }else{
  cx.fillStyle='#D0D0D8';cx.fillRect(mx-7,y+31+flt,4,7);cx.fillRect(mx+3,y+31-flt,4,7);
  cx.fillStyle='#5566AA';cx.fillRect(mx-8,y+37+flt,6,4);cx.fillRect(mx+2,y+37-flt,6,4);
 }
 // Backpack
 cx.fillStyle='#556677';cx.fillRect(mx-12,y+16,5,13);
 cx.fillStyle='#778899';cx.fillRect(mx-11,y+17,3,11);
 cx.fillStyle='#999';cx.fillRect(mx-10,y+12,2,5);
 // Body outline + body
 cx.fillStyle='#222233';cx.fillRect(mx-8,y+15,16,17);
 cx.fillStyle='#E0E0E8';cx.fillRect(mx-7,y+16,14,15);
 // Chest panel
 cx.fillStyle='#FF6644';cx.fillRect(mx-3,y+19,6,5);
 if(fc%50<28){cx.fillStyle='#88FF88';cx.fillRect(mx-2,y+20,2,2);cx.fillStyle='#FFAA44';cx.fillRect(mx+1,y+20,2,2);}
 else{cx.fillStyle='#447744';cx.fillRect(mx-2,y+20,2,2);cx.fillStyle='#886633';cx.fillRect(mx+1,y+20,2,2);}
 // Belt
 cx.fillStyle='#AAAABC';cx.fillRect(mx-7,y+28,14,2);
 cx.fillStyle='#FFCC44';cx.fillRect(mx-1,y+28,3,2);
 // Arms
 if(wk){
  const as=(-ws*2.5)|0;
  cx.fillStyle='#E0E0E8';cx.fillRect(mx-13,y+19+as,4,9);cx.fillRect(mx+9,y+19-as,4,9);
  cx.fillStyle='#C0C0CC';cx.fillRect(mx-13,y+27+as,4,3);cx.fillRect(mx+9,y+27-as,4,3);
 }else{
  const as=(Math.sin(fc*0.012)*3)|0;
  cx.fillStyle='#E0E0E8';cx.fillRect(mx-14,y+11+as,4,9);cx.fillRect(mx+10,y+11-as,4,9);
  cx.fillStyle='#C0C0CC';cx.fillRect(mx-14,y+10+as,4,3);cx.fillRect(mx+10,y+10-as,4,3);
 }
 // Neck
 cx.fillStyle='#AAAABC';cx.fillRect(mx-3,y+13,2,3);cx.fillRect(mx+1,y+13,2,3);
 // Helmet
 cx.fillStyle='#222233';cx.beginPath();cx.arc(mx,y+8,9,0,Math.PI*2);cx.fill();
 cx.fillStyle='#E8E8F0';cx.beginPath();cx.arc(mx,y+8,8,0,Math.PI*2);cx.fill();
 cx.fillStyle='#44AAFF';cx.beginPath();cx.arc(mx+1,y+8,5.5,-0.9,0.9);cx.fill();
 cx.fillStyle='#88CCFF';cx.fillRect(mx+3,y+6,2,2);
 cx.fillStyle='rgba(255,255,255,0.3)';cx.fillRect(mx+4,y+7,1,1);
 // Antenna
 cx.fillStyle='#D0D0D8';cx.fillRect(mx,y+1,2,7);
 cx.fillStyle=fc%45<22?'#FF3333':'#881111';cx.fillRect(mx-1,y-1,3,3);
 // Dust
 if(wk&&rv.al&&fc%3===0)addP(mx+(Math.random()-.5)*10,GY-1,-0.8-Math.random()*0.5,-.15-Math.random()*.2,12,2,'#B0A8B8');
 cx.restore();
}

// ===== OBSTACLES =====
function mjh(){return(JV*JV)/(2*BG*GRAV);}
const CRYS=['#44DDCC','#FF66AA','#FFAA44','#88FF88','#AA88FF'];
function spawnObs(){
 const df=Math.min(dist/800,1),mh=mjh()*.3,mn=10;
 const rh=()=>mn+Math.random()*(Math.min(mh,30)-mn);
 const bw=16+Math.random()*12;
 const rl=Math.random();
 const mk=()=>({x:0,w:bw,h:rh(),cr:Math.random()<0.35,cc:CRYS[(Math.random()*CRYS.length)|0]});
 if(rl<.55-df*.1){const o=mk();o.x=W+10;obs.push(o);ocd=140+Math.random()*80-df*25;}
 else if(rl<.83-df*.08){let o=mk();o.x=W+10;obs.push(o);o=mk();o.x=W+10+bw+28+Math.random()*20;obs.push(o);ocd=180+Math.random()*90-df*30;}
 else{let sx=W+10;for(let i=0;i<3;i++){const o=mk();o.x=sx;o.w=bw*.85;obs.push(o);sx+=bw*.85+22+Math.random()*18;}ocd=220+Math.random()*100-df*35;}
 ocd=Math.max(ocd,100);
}
function drwObs(){
 for(const o of obs){
  const x=o.x|0,oy=(GY-o.h)|0,w=o.w|0,h=o.h|0;
  // Shadow
  cx.fillStyle='rgba(0,0,0,0.2)';cx.beginPath();cx.moveTo(x+w*.1+2,oy+h+2);cx.lineTo(x+2,oy+h*.35+2);cx.lineTo(x+w*.25+2,oy+2);cx.lineTo(x+w*.6+2,oy+h*.05+2);cx.lineTo(x+w+2,oy+h*.4+2);cx.lineTo(x+w*.88+2,oy+h+2);cx.closePath();cx.fill();
  // Rock body
  cx.fillStyle='#5A5268';cx.beginPath();cx.moveTo(x+w*.1,oy+h);cx.lineTo(x,oy+h*.35);cx.lineTo(x+w*.25,oy);cx.lineTo(x+w*.6,oy+h*.05);cx.lineTo(x+w,oy+h*.4);cx.lineTo(x+w*.88,oy+h);cx.closePath();cx.fill();
  // Light face
  cx.fillStyle='#7A7290';cx.beginPath();cx.moveTo(x+w*.25,oy);cx.lineTo(x+w*.6,oy+h*.05);cx.lineTo(x+w*.5,oy+h*.6);cx.lineTo(x+w*.3,oy+h*.55);cx.closePath();cx.fill();
  // Highlight
  cx.fillStyle='#9A92B0';cx.beginPath();cx.moveTo(x+w*.25,oy);cx.lineTo(x+w*.4,oy+h*.03);cx.lineTo(x+w*.35,oy+h*.3);cx.lineTo(x+w*.28,oy+h*.25);cx.closePath();cx.fill();
  // Crystal
  if(o.cr){
   cx.fillStyle=o.cc;cx.globalAlpha=0.85;cx.beginPath();cx.moveTo(x+w*.3,oy+h*.15);cx.lineTo(x+w*.38,oy-5);cx.lineTo(x+w*.46,oy+h*.1);cx.closePath();cx.fill();
   cx.fillStyle='#FFF';cx.globalAlpha=0.3;cx.fillRect(x+w*.36|0,oy-3,2,4);
   cx.globalAlpha=0.12;cx.fillStyle=o.cc;cx.beginPath();cx.arc(x+w*.38,oy-2,8,0,Math.PI*2);cx.fill();
   cx.globalAlpha=1;
  }
 }
}
function chkCol(){
 const rx=RX+5,ry=rv.y+10,rw=RW-10,rh=RH-16;
 for(const o of obs){if(rx<o.x+o.w-4&&rx+rw>o.x+4&&ry<GY-3&&ry+rh>GY-o.h+4)return true;}
 return false;
}

// ===== BACKGROUND =====
function drwBg(){
 // Sky gradient
 const g=cx.createLinearGradient(0,0,0,GY);
 g.addColorStop(0,'#0B0E2B');g.addColorStop(0.4,'#151A3A');g.addColorStop(0.7,'#1A2555');g.addColorStop(1,'#203880');
 cx.fillStyle=g;cx.fillRect(0,0,W,GY);
 // Nebula
 cx.globalAlpha=0.04;
 cx.fillStyle='#6644AA';cx.beginPath();cx.arc(W*0.25,GY*0.3,50,0,Math.PI*2);cx.fill();
 cx.fillStyle='#4466AA';cx.beginPath();cx.arc(W*0.7,GY*0.45,40,0,Math.PI*2);cx.fill();
 cx.fillStyle='#AA4466';cx.beginPath();cx.arc(W*0.5,GY*0.15,30,0,Math.PI*2);cx.fill();
 cx.globalAlpha=1;
 drawStars(1);
 // Earth
 const ex=portrait?W*0.75:640,ey=portrait?55:65;
 cx.fillStyle='#1A3366';cx.beginPath();cx.arc(ex,ey,16,0,Math.PI*2);cx.fill();
 cx.fillStyle='#4488CC';cx.beginPath();cx.arc(ex,ey,14,0,Math.PI*2);cx.fill();
 cx.fillStyle='#44AA55';cx.beginPath();cx.arc(ex-4,ey-2,5,0,Math.PI*2);cx.fill();
 cx.beginPath();cx.arc(ex+5,ey+3,3.5,0,Math.PI*2);cx.fill();
 cx.fillStyle='rgba(200,220,255,0.3)';cx.beginPath();cx.arc(ex+2,ey-3,7,0,Math.PI*.7);cx.fill();
 // Distant hills
 cx.fillStyle='#161640';cx.beginPath();cx.moveTo(0,GY);
 for(let i=0;i<=W;i+=15)cx.lineTo(i,GY-Math.sin((i+gOff*0.015)*0.008)*30-Math.cos((i+gOff*0.015)*0.015)*15-40);
 cx.lineTo(W,GY);cx.fill();
 cx.fillStyle='#1E1E50';cx.beginPath();cx.moveTo(0,GY);
 for(let i=0;i<=W;i+=12)cx.lineTo(i,GY-Math.sin((i+gOff*0.03)*0.01)*18-Math.cos((i+gOff*0.03)*0.02)*10-18);
 cx.lineTo(W,GY);cx.fill();
 // Ground
 const gg=cx.createLinearGradient(0,GY,0,H);
 gg.addColorStop(0,'#B8B0C0');gg.addColorStop(0.12,'#A098A8');gg.addColorStop(0.4,'#787080');gg.addColorStop(1,'#484058');
 cx.fillStyle=gg;cx.fillRect(0,GY,W,H-GY);
 cx.fillStyle='rgba(255,255,255,0.12)';cx.fillRect(0,GY,W,2);
 // Craters
 for(let i=0;i<5;i++){let x2=((i*190+40)-(gOff*0.05)%950+950)%950-50;if(x2>W+50)x2-=W+100;
  cx.fillStyle='rgba(0,0,0,0.1)';cx.beginPath();cx.ellipse(x2,GY+5,18+i*5,3,0,0,Math.PI*2);cx.fill();
  cx.fillStyle='rgba(255,255,255,0.05)';cx.beginPath();cx.ellipse(x2-1,GY+4,16+i*5,2,0,0,Math.PI*2);cx.fill();}
 cx.fillStyle='rgba(0,0,0,0.05)';for(let y=GY+16;y<H;y+=18)cx.fillRect(0,y,W,1);
 cx.fillStyle='rgba(0,0,0,0.07)';for(let i=0;i<W+40;i+=30){const wx=((i-(gOff|0)%30)+W*10)%(W+40)-20;cx.fillRect(wx|0,GY+1,1,5);}
}

// ===== TITLE SCREEN =====
let titleA=0;
function drwTitle(){
 cx.fillStyle='#0B0E2B';cx.fillRect(0,0,W,H);
 // Nebula
 cx.globalAlpha=0.05;
 cx.fillStyle='#6644AA';cx.beginPath();cx.arc(W*0.25,H*0.25,60,0,Math.PI*2);cx.fill();
 cx.fillStyle='#4466AA';cx.beginPath();cx.arc(W*0.7,H*0.4,45,0,Math.PI*2);cx.fill();
 cx.globalAlpha=1;
 drawStars(1);titleA+=.015;
 // Earth
 const ex=portrait?W*0.75:640,ey=portrait?55:65;
 cx.fillStyle='#4488CC';cx.beginPath();cx.arc(ex,ey,14,0,Math.PI*2);cx.fill();
 cx.fillStyle='#44AA55';cx.beginPath();cx.arc(ex-4,ey-2,5,0,Math.PI*2);cx.fill();
 cx.beginPath();cx.arc(ex+5,ey+3,3.5,0,Math.PI*2);cx.fill();
 // Ground distant
 const ggy=portrait?H*0.85:H*0.82;
 cx.fillStyle='#1E1E50';cx.fillRect(0,ggy,W,H-ggy);
 cx.fillStyle='rgba(255,255,255,0.06)';cx.fillRect(0,ggy,W,1);
 // Title
 const ty=portrait?130:90,tsz=portrait?22:28;
 cx.fillStyle='#000';cx.font=tsz+'px '+FN;cx.textAlign='center';cx.textBaseline='middle';
 cx.fillText('GRAVITY',W/2+2,ty+2);cx.fillText('RUNNER',W/2+2,ty+42);
 cx.fillStyle='#FFCC44';cx.fillText('GRAVITY',W/2,ty);
 cx.fillStyle='#FF8844';cx.fillText('RUNNER',W/2,ty+40);
 txts('MOON MISSION',W/2,ty+75,portrait?6:7,'#8888BB','center');
 // Floating astronaut
 const acy=portrait?H*0.46:240;
 const ax=W/2+Math.sin(titleA)*W*0.15,ay=acy+Math.sin(titleA*1.8)*12;
 cx.save();cx.translate(ax,ay);cx.rotate(Math.sin(titleA*1.8)*.06);
 // Mini astronaut body
 cx.fillStyle='#222';cx.beginPath();cx.arc(0,-12,8,0,Math.PI*2);cx.fill();
 cx.fillStyle='#E8E8F0';cx.beginPath();cx.arc(0,-12,7,0,Math.PI*2);cx.fill();
 cx.fillStyle='#44AAFF';cx.beginPath();cx.arc(1,-12,4.5,-0.8,0.8);cx.fill();
 cx.fillStyle='#88CCFF';cx.fillRect(3,-14,2,2);
 cx.fillStyle='#222';cx.fillRect(-7,-4,14,16);
 cx.fillStyle='#E0E0E8';cx.fillRect(-6,-3,12,14);
 cx.fillStyle='#FF6644';cx.fillRect(-2,-1,4,4);
 cx.fillStyle='#556677';cx.fillRect(-10,-3,4,11);cx.fillStyle='#778899';cx.fillRect(-9,-2,2,9);
 const fa=Math.sin(titleA*2)*2;
 cx.fillStyle='#E0E0E8';cx.fillRect(-11,-8+(fa|0),4,8);cx.fillRect(7,-8-(fa|0),4,8);
 cx.fillStyle='#C0C0CC';cx.fillRect(-11,-9+(fa|0),4,3);cx.fillRect(7,-9-(fa|0),4,3);
 const fl=(Math.sin(titleA*2.5)*1.5)|0;
 cx.fillStyle='#D0D0D8';cx.fillRect(-5,11+fl,4,6);cx.fillRect(1,11-fl,4,6);
 cx.fillStyle='#5566AA';cx.fillRect(-6,16+fl,5,4);cx.fillRect(1,16-fl,5,4);
 cx.fillStyle='#D0D0D8';cx.fillRect(0,-18,2,6);
 cx.fillStyle=fc%45<22?'#FF3333':'#881111';cx.fillRect(-1,-19,3,3);
 // Jet trail
 const jc=['#FF4400','#FF8800','#FFCC00'];
 for(let i=0;i<3;i++){cx.fillStyle=jc[i];cx.fillRect(-2+(Math.random()*4)|0,20+i*5,2,4);}
 cx.restore();
 // Particle trail
 cx.globalAlpha=0.1;cx.fillStyle='#FFAA44';
 for(let i=1;i<6;i++)cx.fillRect(ax-i*16+(Math.random()*4)|0,ay+(Math.random()*4)|0,3,2);
 cx.globalAlpha=1;
 // Prompt
 const py=portrait?H*0.72:330;
 if(fc%70<50){
  txts(portrait?'TAP TO START':'PRESS SPACE / TAP',W/2,py,portrait?8:9,'#DDDDFF','center');
  if(!portrait)txts('TO START',W/2,py+20,9,'#DDDDFF','center');
 }
 if(best>0)txts('BEST: '+best+'m',W/2,portrait?H*0.82:380,6,'#8888AA','center');
}

// ===== HUD =====
function drwHUD(){
 const fsz=portrait?10:12;
 txts((dist|0)+'m',W-15,22,fsz,'#FFF','right');
 if(best>0)txts('BEST:'+best+'m',W-15,40,5,'#8888AA','right');
 txts('MOON',15,18,portrait?6:7,'#AAAACC');
 txts('1.62 m/s\xB2',15,32,4,'#777799');
 // Jump dots
 for(let j=0;j<2;j++){
  const jx=(portrait?60:80)+j*13,jy=28;
  cx.fillStyle=j<rv.jc?'rgba(80,80,120,0.4)':'rgba(100,160,255,0.4)';
  cx.beginPath();cx.arc(jx,jy,5,0,Math.PI*2);cx.fill();
  if(j>=rv.jc){cx.fillStyle='#44AAFF';cx.beginPath();cx.arc(jx,jy,3,0,Math.PI*2);cx.fill();}
 }
 txts('JUMP',portrait?60:80,16,4,'#8888BB','center');
 // Speed bar
 const sbw=portrait?60:88,sp2=Math.min((gs-BS)/(MS-BS),1);
 cx.fillStyle='rgba(0,0,0,0.3)';cx.fillRect(W-sbw-30,50,sbw,5);
 cx.fillStyle='#FFCC44';cx.fillRect(W-sbw-30,50,(sbw*sp2)|0,5);
 cx.fillStyle='rgba(255,255,255,0.25)';cx.fillRect(W-sbw-30,50,(sbw*sp2)|0,2);
 // Tutorial
 if(tut&&tutT>0){
  cx.globalAlpha=Math.min(tutT/25,1);
  const tw=portrait?340:380,th=portrait?90:84;
  cx.fillStyle='rgba(10,10,40,0.9)';cx.fillRect((W/2-tw/2)|0,(GY/2-th/2)|0,tw,th);
  cx.strokeStyle='rgba(100,160,255,0.3)';cx.lineWidth=2;cx.strokeRect((W/2-tw/2)|0,(GY/2-th/2)|0,tw,th);
  const tc=GY/2;
  txts(portrait?'TAP TO JUMP':'SPACE / TAP TO JUMP',W/2,tc-22,portrait?7:8,'#88CCFF','center');
  txts('DOUBLE JUMP IN AIR!',W/2,tc-2,portrait?6:7,'#AADDFF','center');
  txts('YOU FLOAT LIKE A BALLOON!',W/2,tc+18,portrait?5:6,'#FFCC44','center');
  txts('DRIFT OVER THE ROCKS!',W/2,tc+34,portrait?5:6,'#FF8844','center');
  cx.globalAlpha=1;tutT--;
 }
}

// ===== GAME OVER =====
function drwGO(){
 cx.fillStyle='rgba(8,8,30,0.88)';cx.fillRect(0,0,W,H);
 const cy=portrait?H*0.06:55;
 cx.fillStyle='#000';cx.font=(portrait?16:20)+'px '+FN;cx.textAlign='center';cx.textBaseline='middle';
 cx.fillText('GAME OVER',W/2+2,cy+2);cx.fillStyle='#FF6644';cx.fillText('GAME OVER',W/2,cy);
 const dy=cy+37;
 txts('DISTANCE: '+(dist|0)+' m',W/2,dy,portrait?8:10,'#FFF','center');
 if((dist|0)>=best&&dist>0){if(fc%35<22)txts('NEW RECORD!',W/2,dy+22,portrait?7:8,'#FFCC44','center');}
 else if(best>0)txts('BEST: '+best+'m',W/2,dy+22,portrait?6:7,'#777799','center');

 const iy=dy+45;
 if(!sLB){
  txts('INITIALS:',W/2-78,iy+11,6,'#8888AA','center');
  for(let i=0;i<3;i++){
   const bx=W/2-35+i*32,by=iy;
   cx.fillStyle=i===iSl?'rgba(68,170,255,0.15)':'rgba(40,40,80,0.4)';cx.fillRect(bx,by,26,28);
   cx.strokeStyle=i===iSl?'#44AAFF':'#555';cx.lineWidth=i===iSl?2:1;cx.strokeRect(bx,by,26,28);
   txts(ini[i],bx+13,by+14,11,'#FFF','center');
  }
  txts('^',W/2-35+iSl*32+13,iy-6,5,'#88CCFF','center');
  txts('v',W/2-35+iSl*32+13,iy+34,5,'#88CCFF','center');
  cx.fillStyle='rgba(68,170,255,0.12)';rr(W/2+65,iy+3,60,24,3);cx.fill();
  cx.strokeStyle='#44AAFF';cx.lineWidth=1;rr(W/2+65,iy+3,60,24,3);cx.stroke();
  txts('OK',W/2+95,iy+15,8,'#88CCFF','center');
 }

 const ly=sLB?iy:iy+48;
 txts('[ RANKING ]',W/2,ly,portrait?6:7,'#FFCC44','center');
 for(let i=0;i<5;i++){
  const e=lb[i],ey2=ly+18+i*17;
  const md=['1st','2nd','3rd','4th','5th'][i];
  const ec=i===0?'#FFCC44':i<3?'#DDDDFF':'#777799';
  if(e)txts(md+'  '+e.n+'  '+e.d+'m',W/2,ey2,portrait?5:6,ec,'center');
  else txts(md+'  ---',W/2,ey2,portrait?5:6,'#444466','center');
 }
 const btnY=ly+108;
 cx.fillStyle='rgba(68,170,255,0.1)';rr(W/2-135,btnY,115,30,3);cx.fill();
 cx.strokeStyle='#44AAFF';cx.lineWidth=1;rr(W/2-135,btnY,115,30,3);cx.stroke();
 txts('RETRY',W/2-78,btnY+15,8,'#88CCFF','center');
 cx.fillStyle='rgba(255,255,255,0.04)';rr(W/2+20,btnY,115,30,3);cx.fill();
 cx.strokeStyle='#666688';rr(W/2+20,btnY,115,30,3);cx.stroke();
 txts('MENU',W/2+78,btnY+15,8,'#8888AA','center');
}

// ===== TRANSITIONS =====
function trTo(s){if(tPh!=='n')return;tPh='o';tA=0;tNx=s;}
function updTr(){if(tPh==='o'){tA+=.06;if(tA>=1){tA=1;st=tNx;onEn(tNx);tPh='i';}}else if(tPh==='i'){tA-=.06;if(tA<=0){tA=0;tPh='n';}}}
function drwTr(){if(tA>0){cx.fillStyle=`rgba(8,8,30,${tA})`;cx.fillRect(0,0,W,H);}}
function onEn(s){if(s==='game')initG();if(s==='gameover')initGO();}

// ===== GAME INIT =====
function initG(){
 gs=BS;dist=0;rv={y:GY-RH,vy:0,og:true,al:true,jc:0,wA:0,sw:0};
 obs=[];pts=[];gOff=0;ocd=200;shk=0;tutT=tut?240:0;
}
function initGO(){
 sLB=false;iSl=0;ini=['A','A','A'];svBest();shk=15;
 const cols=['#FF6644','#FFCC44','#44AAFF','#FF66AA','#88FF88','#E8E8F0'];
 for(let i=0;i<30;i++)addP(RX+RW/2,rv.y+RH/2,(Math.random()-.5)*6,(Math.random()-.5)*6-2,30+Math.random()*25,1+Math.random()*2.5,cols[(Math.random()*cols.length)|0]);
}

// ===== INPUT =====
function doJump(){
 if(st==='title'){trTo('game');return;}
 if(st==='game'&&rv.al){
  if(rv.og){rv.vy=JV;rv.og=false;rv.jc=1;tut=false;tutT=0;}
  else if(rv.jc===1){
   rv.vy=JV*0.65;rv.jc=2;
   for(let i=0;i<8;i++)addP(RX+RW/2+(Math.random()-.5)*18,rv.y+RH/2,(Math.random()-.5)*3,-Math.random()*2-0.5,16,2,'#FFCC44');
  }
 }
}
function doClick(pos){
 if(st==='title'){trTo('game');return;}
 if(st==='gameover'){
  if(!sLB){
   const iy=(portrait?H*0.06:55)+37+45;
   for(let i=0;i<3;i++){if(inR(pos,W/2-35+i*32,iy,26,28)){iSl=i;let c=ini[i].charCodeAt(0);c++;if(c>90)c=48;if(c>57&&c<65)c=65;ini[i]=String.fromCharCode(c);return;}}
   if(inR(pos,W/2-35+iSl*32,iy-7,26,14)){let c=ini[iSl].charCodeAt(0);c++;if(c>90)c=48;if(c>57&&c<65)c=65;ini[iSl]=String.fromCharCode(c);return;}
   if(inR(pos,W/2-35+iSl*32,iy+28,26,14)){let c=ini[iSl].charCodeAt(0);c--;if(c<48)c=90;if(c>57&&c<65)c=57;ini[iSl]=String.fromCharCode(c);return;}
   if(inR(pos,W/2+65,iy+3,60,24)){svSc();sLB=true;return;}
  }
  const iy2=(portrait?H*0.06:55)+37+45;
  const ly=sLB?iy2:iy2+48,btnY=ly+108;
  if(inR(pos,W/2-135,btnY,115,30)){trTo('game');return;}
  if(inR(pos,W/2+20,btnY,115,30)){trTo('title');return;}
 }
}

document.addEventListener('keydown',e=>{
 if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();if(!jP)doJump();jP=true;}
 if(e.code==='Enter'){if(st==='title')trTo('game');else if(st==='gameover'&&!sLB){svSc();sLB=true;}}
 if(st==='gameover'&&!sLB){
  if(e.key.length===1&&/[A-Za-z0-9]/.test(e.key)){ini[iSl]=e.key.toUpperCase();if(iSl<2)iSl++;}
  if(e.code==='Backspace'){e.preventDefault();if(iSl>0)iSl--;}
  if(e.code==='ArrowLeft'&&iSl>0)iSl--;if(e.code==='ArrowRight'&&iSl<2)iSl++;
  if(e.code==='ArrowUp'){let c=ini[iSl].charCodeAt(0);c++;if(c>90)c=48;if(c>57&&c<65)c=65;ini[iSl]=String.fromCharCode(c);}
  if(e.code==='ArrowDown'){let c=ini[iSl].charCodeAt(0);c--;if(c<48)c=90;if(c>57&&c<65)c=57;ini[iSl]=String.fromCharCode(c);}
 }
});
document.addEventListener('keyup',e=>{if(e.code==='Space'||e.code==='ArrowUp')jP=false;});
cv.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0],p=gc(t.clientX,t.clientY);if(st==='game'){if(!jP)doJump();jP=true;}else doClick(p);},{passive:false});
cv.addEventListener('touchend',e=>{e.preventDefault();jP=false;},{passive:false});
cv.addEventListener('mousedown',e=>{const p=gc(e.clientX,e.clientY);if(st==='game'){if(!jP)doJump();jP=true;}else doClick(p);});
cv.addEventListener('mouseup',()=>{jP=false;});

// ===== UPDATE =====
function update(){
 fc++;updTr();
 if(tPh!=='n')return;
 if(st==='game'&&rv.al){
  if(!rv.og){
   if(rv.vy<0){rv.vy+=BG*GRAV;}
   else{rv.vy*=DRAG;rv.vy+=BG*GRAV*0.55;if(rv.vy>TVEL)rv.vy=TVEL;}
   rv.y+=rv.vy;rv.sw+=0.035;
   if(rv.y>=GY-RH){
    rv.y=GY-RH;rv.vy=0;rv.og=true;rv.jc=0;rv.sw=0;
    for(let i=0;i<5;i++)addP(RX+Math.random()*RW,GY-2,(Math.random()-.5)*2.5,-Math.random()*1.2,18,2,'#A098A8');
   }
  }
  if(rv.og)rv.wA+=gs*0.12;
  gs=Math.min(BS+dist*SI,MS);dist+=gs*.05;gOff+=gs;
  for(let i=obs.length-1;i>=0;i--){obs[i].x-=gs;if(obs[i].x<-60)obs.splice(i,1);}
  ocd--;if(ocd<=0)spawnObs();
  if(chkCol()){rv.al=false;st='gameover';onEn('gameover');}
 }
 updP();if(shk>0)shk=Math.max(0,shk-.6);
}

// ===== RENDER =====
function render(){
 cx.save();
 if(shk>0){const s=shk*1.5;cx.translate((Math.random()-.5)*s,(Math.random()-.5)*s);}
 if(st==='title')drwTitle();
 else if(st==='game'||st==='gameover'){drwBg();drwObs();drwP();if(rv.al)drwAstro();drwHUD();if(st==='gameover')drwGO();}
 cx.restore();drwTr();
}

resize();
(function loop(){update();render();requestAnimationFrame(loop);})();
</script>
</body>
</html>